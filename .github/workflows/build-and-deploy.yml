name: Build and Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: blacksmith-32vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - name: Record runner start time
        id: runner_time
        run: echo "runner_ts=$(date +%s)" >> $GITHUB_OUTPUT


      - name: Setup Node.js
        uses: useblacksmith/setup-node@v5
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Cache Vercel CLI
        id: vercel-cache
        uses: useblacksmith/cache@v5
        with:
          path: ~/.npm-global
          key: vercel-cli-${{ runner.os }}

      - name: Install Vercel CLI
        if: steps.vercel-cache.outputs.cache-hit != 'true'
        run: |
          npm config set prefix ~/.npm-global
          npm i -g vercel

      - name: Add Vercel CLI to PATH
        run: echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Read build info
        id: build_info
        run: |
          source ./build
          echo "build_id=$build_id" >> $GITHUB_OUTPUT
          echo "push_ts=$push_ts" >> $GITHUB_OUTPUT
          echo "runner_ts=${{ steps.runner_time.outputs.runner_ts }}" >> $GITHUB_OUTPUT

      # --- COLD BUILD & DEPLOY ---
      - name: Cold build and deploy
        id: cold
        run: |
          source ./build
          
          # Reset benchmark marker
          cat > app/bench/marker.tsx << 'MARKER'
          // Marker: baseline
          export function BenchmarkMarker() {
            return <span data-benchmark="baseline" style={{ display: 'none' }} />
          }
          MARKER
          
          # Clean previous build output to ensure cold build
          rm -rf .vercel/output
          
          # Build
          START_TS=$(date +%s)
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          END_TS=$(date +%s)
          
          # Deploy
          vercel deploy --archive=tgz --prebuilt --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
          READY_TS=$(date +%s)
          
          echo "start_ts=$START_TS" >> $GITHUB_OUTPUT
          echo "end_ts=$END_TS" >> $GITHUB_OUTPUT
          echo "ready_ts=$READY_TS" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # --- INCREMENTAL BUILD & DEPLOY ---
      - name: Incremental build and deploy
        id: incr
        run: |
          source ./build
          PUSH_TS=$(date +%s.%N)
          
          # Check cache
          if [ -d ".next/cache" ]; then
            CACHE_SIZE=$(du -sh .next/cache 2>/dev/null | cut -f1 || echo "unknown")
            CACHE_EXISTS=true
          else
            CACHE_SIZE=0
            CACHE_EXISTS=false
          fi
          
          # Modify file to trigger rebuild
          cat > app/bench/marker.tsx << EOF
          // Marker: ${build_id}-incr-$(date +%s)
          export function BenchmarkMarker() {
            return <span data-benchmark="${build_id}-incr" style={{ display: 'none' }} />
          }
          EOF
          
          # Build
          START_TS=$(date +%s)
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          END_TS=$(date +%s)
          
          # Write cold bench.txt (final)
          cat > .vercel/output/static/bench.txt << EOF
          build_id=$build_id
          push_ts=${{ steps.build_info.outputs.push_ts }}
          runner_ts=${{ steps.build_info.outputs.runner_ts }}
          start_ts=${{ steps.cold.outputs.start_ts }}
          end_ts=${{ steps.cold.outputs.end_ts }}
          ready_ts=${{ steps.cold.outputs.ready_ts }}
          next_version=$(node -p "require('next/package.json').version")
          bundler=webpack
          EOF
          
          # Write incremental bench (placeholder)
          cat > .vercel/output/static/bench-incremental.txt << EOF
          build_id=$build_id
          push_ts=$PUSH_TS
          start_ts=$START_TS
          end_ts=$END_TS
          ready_ts=PLACEHOLDER
          next_version=$(node -p "require('next/package.json').version")
          bundler=webpack
          cache_exists=$CACHE_EXISTS
          cache_size=$CACHE_SIZE
          EOF
          
          # Deploy to get ready_ts
          vercel deploy --archive=tgz --prebuilt --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
          READY_TS=$(date +%s)
          
          echo "push_ts=$PUSH_TS" >> $GITHUB_OUTPUT
          echo "start_ts=$START_TS" >> $GITHUB_OUTPUT
          echo "end_ts=$END_TS" >> $GITHUB_OUTPUT
          echo "ready_ts=$READY_TS" >> $GITHUB_OUTPUT
          echo "cache_exists=$CACHE_EXISTS" >> $GITHUB_OUTPUT
          echo "cache_size=$CACHE_SIZE" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # --- FINAL DEPLOY WITH CORRECT TIMESTAMPS ---
      - name: Final deploy
        run: |
          source ./build
          
          # Cold bench.txt (unchanged)
          cat > .vercel/output/static/bench.txt << EOF
          build_id=$build_id
          push_ts=${{ steps.build_info.outputs.push_ts }}
          runner_ts=${{ steps.build_info.outputs.runner_ts }}
          start_ts=${{ steps.cold.outputs.start_ts }}
          end_ts=${{ steps.cold.outputs.end_ts }}
          ready_ts=${{ steps.cold.outputs.ready_ts }}
          next_version=$(node -p "require('next/package.json').version")
          bundler=webpack
          EOF
          
          # Incremental bench with final ready_ts
          cat > .vercel/output/static/bench-incremental.txt << EOF
          build_id=$build_id
          push_ts=${{ steps.incr.outputs.push_ts }}
          start_ts=${{ steps.incr.outputs.start_ts }}
          end_ts=${{ steps.incr.outputs.end_ts }}
          ready_ts=${{ steps.incr.outputs.ready_ts }}
          next_version=$(node -p "require('next/package.json').version")
          bundler=webpack
          cache_exists=${{ steps.incr.outputs.cache_exists }}
          cache_size=${{ steps.incr.outputs.cache_size }}
          EOF
          
          echo "=== Final bench.txt ==="
          cat .vercel/output/static/bench.txt
          echo "=== Final bench-incremental.txt ==="
          cat .vercel/output/static/bench-incremental.txt
          
          vercel deploy --archive=tgz --prebuilt --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
